#!/bin/sh
: "${RADIUS_CLIENT_HOST:=52.32.233.70}"
: "${RADIUS_CLIENT_HOST_2:=52.34.108.34}"
: "${RADIUS_CLIENT_SECRET:=changeme}"
: "${RADIUS_CLIENT_SECRET_2:=changeme}"
: "${RADIUS_CLIENT_PORT:=1812}"
: "${RADIUS_CLIENT_PORT_2:=1812}"
: "${RADIUS_CLIENT_PASS_THROUGH_ALL:=false}"
: "${RADIUS_SERVER_IKEY:=changeme}"
: "${RADIUS_SERVER_SKEY:=changeme}"
: "${RADIUS_SERVER_API_HOST:=api-XXXXXXXX.duosecurity.com}"
# fixme - build this dynamically
: "${RADIUS_SERVER_RADIUS_IP_1:=127.0.0.1}"
: "${RADIUS_SERVER_SECRET_1:=changeme}"
: "${RADIUS_SERVER_RADIUS_IP_2:=127.0.0.1}"
: "${RADIUS_SERVER_SECRET_2:=changeme}"
: "${RADIUS_SERVER_RADIUS_IP_3:=127.0.0.1}"
: "${RADIUS_SERVER_SECRET_3:=changeme}"
: "${RADIUS_SERVER_RADIUS_IP_4:=127.0.0.1}"
: "${RADIUS_SERVER_SECRET_4:=changeme}"
: "${RADIUS_SERVER_RADIUS_IP_5:=127.0.0.1}"
: "${RADIUS_SERVER_SECRET_5:=changeme}"
: "${RADIUS_SERVER_PORT:=1812}"
: "${RADIUS_SERVER_FAILMODE:=secure}"

/bin/sed -i'' \
  -e "s#@RADIUS_CLIENT_HOST@#${RADIUS_CLIENT_HOST}#" \
  -e "s#@RADIUS_CLIENT_HOST_2@#${RADIUS_CLIENT_HOST_2}#" \
  -e "s#@RADIUS_CLIENT_SECRET@#${RADIUS_CLIENT_SECRET}#" \
  -e "s#@RADIUS_CLIENT_SECRET_2@#${RADIUS_CLIENT_SECRET_2}#" \
  -e "s#@RADIUS_CLIENT_PORT@#${RADIUS_CLIENT_PORT}#" \
  -e "s#@RADIUS_CLIENT_PORT_2@#${RADIUS_CLIENT_PORT_2}#" \
  -e "s#@RADIUS_CLIENT_PASS_THROUGH_ALL@#${RADIUS_CLIENT_PASS_THROUGH_ALL}#" \
  -e "s#@RADIUS_SERVER_IKEY@#${RADIUS_SERVER_IKEY}#" \
  -e "s#@RADIUS_SERVER_SKEY@#${RADIUS_SERVER_SKEY}#" \
  -e "s#@RADIUS_SERVER_API_HOST@#${RADIUS_SERVER_API_HOST}#" \
  -e "s#@RADIUS_SERVER_RADIUS_IP_1@#${RADIUS_SERVER_RADIUS_IP_1}#" \
  -e "s#@RADIUS_SERVER_RADIUS_SECRET_1@#${RADIUS_SERVER_SECRET_1}#" \
  -e "s#@RADIUS_SERVER_RADIUS_IP_2@#${RADIUS_SERVER_RADIUS_IP_2}#" \
  -e "s#@RADIUS_SERVER_RADIUS_SECRET_2@#${RADIUS_SERVER_SECRET_2}#" \
  -e "s#@RADIUS_SERVER_RADIUS_IP_3@#${RADIUS_SERVER_RADIUS_IP_3}#" \
  -e "s#@RADIUS_SERVER_RADIUS_SECRET_3@#${RADIUS_SERVER_SECRET_3}#" \
  -e "s#@RADIUS_SERVER_RADIUS_IP_4@#${RADIUS_SERVER_RADIUS_IP_4}#" \
  -e "s#@RADIUS_SERVER_RADIUS_SECRET_4@#${RADIUS_SERVER_SECRET_4}#" \
  -e "s#@RADIUS_SERVER_RADIUS_IP_5@#${RADIUS_SERVER_RADIUS_IP_5}#" \
  -e "s#@RADIUS_SERVER_RADIUS_SECRET_5@#${RADIUS_SERVER_SECRET_5}#" \
  -e "s#@RADIUS_SERVER_PORT@#${RADIUS_SERVER_PORT}#" \
  -e "s#@RADIUS_SERVER_FAILMODE@#${RADIUS_SERVER_FAILMODE}#" \
  /duoauthproxy/conf/authproxy.cfg

echo "generated config:"
/bin/sed \
  -e "s/${RADIUS_CLIENT_SECRET}/${RADIUS_CLIENT_SECRET:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_CLIENT_SECRET_2}/${RADIUS_CLIENT_SECRET_2:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_SERVER_SKEY}/${RADIUS_SERVER_SKEY:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_SERVER_SECRET_1}/${RADIUS_SERVER_SECRET_1:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_SERVER_SECRET_2}/${RADIUS_SERVER_SECRET_2:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_SERVER_SECRET_3}/${RADIUS_SERVER_SECRET_3:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_SERVER_SECRET_4}/${RADIUS_SERVER_SECRET_4:0:2}xxxxxxxx/" \
  -e "s/${RADIUS_SERVER_SECRET_5}/${RADIUS_SERVER_SECRET_5:0:2}xxxxxxxx/" \
  /duoauthproxy/conf/authproxy.cfg

exec /duoauthproxy/bin/authproxy -c /duoauthproxy/conf/authproxy.cfg
